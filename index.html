<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <!-- iOS Web App support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="VideoWalker" />
    
    <title>Location-Based YouTube Video Playback</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
      * {
        touch-action: manipulation; /* Prevents double-tap zoom on iOS */
      }
      
      body { 
        font-family: Arial, sans-serif; 
        margin: 0;
        padding: 0;
        touch-action: pan-x pan-y;
        -webkit-text-size-adjust: 100%; /* Prevents text zoom on iOS */
      }
      
      /* Common styling for all intro pages */
      .intro-page {
        text-align: center;
        padding: 50px 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      
      .intro-page h1 {
        font-size: 28px;
        margin-bottom: 30px;
        line-height: 1.4;
      }
      
      .intro-page h2 {
        font-size: 24px;
        margin-bottom: 30px;
        line-height: 1.4;
      }
      
      .intro-page p {
        font-size: 18px;
        margin-bottom: 40px;
        line-height: 1.6;
      }
      
      /* Button styling */
      .intro-page button,
      .languageButton {
        padding: 15px 40px;
        font-size: 18px;
        cursor: pointer;
        border: 2px solid #333;
        background-color: #fff;
        color: #333;
        border-radius: 5px;
        transition: all 0.3s ease;
        min-width: 200px;
        margin: 10px;
        touch-action: manipulation; /* Prevents zoom delay on tap */
      }
      
      .intro-page button:hover,
      .languageButton:hover {
        background-color: #333;
        color: #fff;
      }
      
      .languageButton {
        font-size: 20px;
        min-width: 220px;
      }
      
      /* Map page - fullscreen */
      #mapPage {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
      }
      
      #map { 
        width: 100%; 
        height: 100vh;
        touch-action: none;
      }
      
      /* Video page - fullscreen with black background */
      #videoPage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background-color: #000;
        z-index: 2000;
      }
      
      #videoPage:not(.hidden) {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      #videoContainer {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      #player { 
        width: 100%; 
        height: 100%;
      }
      
      #closeVideo {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 2001;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        background-color: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 5px;
        color: #333;
      }
      
      #closeVideo:hover {
        background-color: #fff;
      }
      
      /* Popup play button */
      .popup-play-button {
        display: block;
        margin-top: 10px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        background-color: #333;
        color: #fff;
        border: none;
        border-radius: 5px;
      }
      
      .popup-play-button:hover {
        background-color: #555;
      }
      
      /* Menu button */
      #menuButton {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background-color: rgba(255, 255, 255, 0.9);
        border: 2px solid #333;
        border-radius: 50%;
        cursor: pointer;
        z-index: 1500;
        display: none; /* Hidden by default, shown only on map page */
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      
      #menuButton.show {
        display: flex; /* Show when map page is active */
      }
      
      #menuButton:hover {
        background-color: #fff;
      }
      
      /* Menu overlay */
      #menuOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 2500;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
      }
      
      #menuOverlay:not(.hidden) {
        display: flex;
      }
      
      #menuOverlay .menu-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
      }
      
      #menuOverlay button {
        width: 80%;
        max-width: 300px;
        padding: 15px 30px;
        margin: 10px 0;
        font-size: 18px;
        cursor: pointer;
        border: 2px solid #fff;
        background-color: transparent;
        color: #fff;
        border-radius: 5px;
        transition: all 0.3s ease;
      }
      
      #menuOverlay button:hover {
        background-color: #fff;
        color: #333;
      }
      
      #menuOverlay .version-info {
        color: #999;
        font-size: 14px;
        margin-top: 30px;
      }
      
      /* Impressum page */
      #impressumPage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background-color: #fff;
        z-index: 2000;
        overflow-y: auto;
        padding: 20px;
      }
      
      #impressumPage .close-button {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        background-color: #333;
        color: #fff;
        border: none;
        border-radius: 5px;
      }
      
      #impressumPage .content {
        max-width: 800px;
        margin: 60px auto 20px;
      }
      
      /* Debug info */
      #debugInfo {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.8);
        color: #0f0;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 11px;
        z-index: 1000;
        max-width: 90%;
      }
      
      #debugInfo div {
        margin: 2px 0;
      }
      
      .hidden { display: none; }
    </style>
  </head>
  <body>
    <div id="languagePage" class="intro-page">
      <div>
        <button class="languageButton" data-lang="en">English</button>
        <button class="languageButton" data-lang="de">Deutsch</button>
      </div>
    </div>
    
    <div id="fullscreenPage" class="intro-page hidden">
      <h1 data-i18n="fullscreenTitle">Location-Based YouTube Video Experience</h1>
      <p data-i18n="fullscreenDescription">For the best experience, we recommend using fullscreen mode.</p>
      <button id="enterFullscreen" data-i18n="fullscreenButton">Enter Fullscreen & Start</button>
    </div>
    
    <div id="infoPage" class="intro-page hidden">
      <h1 data-i18n="infoTitle">Welcome to the Location-Based YouTube Video Experience</h1>
      <p data-i18n="infoDescription">This page will guide you through an interactive location-based video experience.</p>
      <button id="nextToConsent" data-i18n="nextButton">Next</button>
    </div>

    <div id="consentPage" class="intro-page hidden">
      <h2 data-i18n="consentTitle">We need your consent for location tracking</h2>
      <button id="acceptConsent" data-i18n="consentButton">Accept and Continue</button>
    </div>

    <div id="mapPage" class="hidden">
      <button id="menuButton">☰</button>
      <div id="map"></div>
    </div>
    
    <div id="menuOverlay" class="hidden">
      <div class="menu-buttons">
        <button id="menuMapHome" data-i18n="menuMapHome">Map Home</button>
        <button id="menuFullscreen" data-i18n="menuFullscreen">Toggle Fullscreen</button>
        <button id="menuLanguage" data-i18n="menuLanguage">Change Language</button>
        <button id="menuRestart" data-i18n="menuRestart">Restart Experience</button>
        <button id="menuImpressum" data-i18n="menuImpressum">Impressum</button>
        <button id="menuDebug" data-i18n="menuDebug">Toggle Debug Mode</button>
        <button id="menuClose" data-i18n="menuClose">Close Menu</button>
      </div>
      <div class="version-info" id="menuVersion">v1.1.4</div>
    </div>
    
    <div id="impressumPage" class="hidden">
      <button class="close-button" data-i18n="closeButton">Close</button>
      <div class="content" id="impressumContent">
        <h1 data-i18n="impressumTitle">Impressum</h1>
        <p data-i18n="impressumText">No impressum information configured.</p>
      </div>
    </div>
    
    <div id="debugInfo" class="hidden">
      <div id="debugLat">Lat: --</div>
      <div id="debugLng">Lng: --</div>
      <div id="debugAcc">Accuracy: --</div>
      <div id="debugUpdates">Updates: 0</div>
      <div id="debugNearest">Nearest: --</div>
    </div>
    
    <div id="videoPage" class="hidden">
      <button id="closeVideo" data-i18n="closeVideoButton">Close Video</button>
      <div id="videoContainer">
        <div id="player"></div> <!-- YouTube IFrame API will replace this div with the video player -->
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet/leaflet-maplibre-gl.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script> <!-- YouTube IFrame API -->
    <script>

      // Wait for DOM to be fully loaded
      document.addEventListener('DOMContentLoaded', function() {

      // Prevent pinch-zoom on iOS
      document.addEventListener('gesturestart', function(e) {
        e.preventDefault();
      });
      
      document.addEventListener('gesturechange', function(e) {
        e.preventDefault();
      });
      
      document.addEventListener('gestureend', function(e) {
        e.preventDefault();
      });
      
      // Prevent double-tap zoom on iOS
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      // 0. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // rest of code

      // Translations
      const translations = {
        en: {
          fullscreenTitle: "VideoWalk Experience",
          fullscreenDescription: "For the best experience, we recommend using fullscreen mode.",
          fullscreenButton: "Enter Fullscreen & Start",
          infoTitle: "Welcome to the VideoWalk Experience",
          infoDescription: "This page will guide you through an interactive location-based video experience.",
          nextButton: "Next",
          consentTitle: "We need your consent for location tracking",
          consentButton: "Accept and Continue",
          mapTitle: "Your Current Location",
          playVideoButton: "Play Video",
          closeVideoButton: "Close Video",
          menuMapHome: "Map Home",
          menuFullscreen: "Toggle Fullscreen",
          menuRestart: "Restart Experience",
          menuLanguage: "Language: English",
          menuImpressum: "Impressum",
          menuDebug: "Toggle Debug Mode",
          menuClose: "Close",
          closeButton: "Close",
          impressumTitle: "Impressum",
          impressumText: "No impressum information configured."
        },
        de: {
          fullscreenTitle: "VideoWalk Erlebnis",
          fullscreenDescription: "Für das beste Erlebnis empfehlen wir den Vollbildmodus.",
          fullscreenButton: "Vollbild aktivieren & Starten",
          infoTitle: "Willkommen beim VideoWalk Erlebnis",
          infoDescription: "Diese Seite führt Sie durch ein interaktives standortbasiertes Video-Erlebnis.",
          nextButton: "Weiter",
          consentTitle: "Wir benötigen Ihre Zustimmung zur Standortverfolgung",
          consentButton: "Akzeptieren und Fortfahren",
          mapTitle: "Ihr aktueller Standort",
          playVideoButton: "Video abspielen",
          closeVideoButton: "Video schließen",
          menuMapHome: "Karte zentrieren",
          menuFullscreen: "Vollbild umschalten",
          menuRestart: "Erlebnis neu starten",
          menuLanguage: "Sprache: Deutsch",
          menuImpressum: "Impressum",
          menuDebug: "Debug-Modus umschalten",
          menuClose: "Schließen",
          closeButton: "Schließen",
          impressumTitle: "Impressum",
          impressumText: "Keine Impressum-Informationen konfiguriert."
        }
      };

      let selectedLanguage = 'en';
      let debugMode = false;

      let configData = null;
      let videosData = [];
      let videoCircles = []; // Store circles to update popups when language changes
      let map, userMarker, player;
      let videoToLoad = null; // Used to queue video loading if player isn't ready
      let isPlayerReady = false; // Flag to track player readiness
      let watchId = null; // Store the watch ID
      let locationUpdateCount = 0; // Counter for location updates
      let hasInitiallycentered = false; // Flag to track if map has been centered on first location
      let isVideoPlaying = false; // Flag to track if video is currently playing

      const languagePage = document.getElementById('languagePage');
      const languageButtons = document.querySelectorAll('.languageButton');
      const enterFullscreenButton = document.getElementById('enterFullscreen');
      const fullscreenPage = document.getElementById('fullscreenPage');
      const nextButton = document.getElementById('nextToConsent');
      const acceptButton = document.getElementById('acceptConsent');
      const infoPage = document.getElementById('infoPage');
      const consentPage = document.getElementById('consentPage');
      const mapPage = document.getElementById('mapPage');
      const videoPage = document.getElementById('videoPage');
      const closeVideoButton = document.getElementById('closeVideo');
      const videoElement = document.getElementById('locationVideo');
      const menuButton = document.getElementById('menuButton');
      const menuOverlay = document.getElementById('menuOverlay');
      const menuMapHome = document.getElementById('menuMapHome');
      const menuFullscreen = document.getElementById('menuFullscreen');
      const menuRestart = document.getElementById('menuRestart');
      const menuLanguage = document.getElementById('menuLanguage');
      const menuImpressum = document.getElementById('menuImpressum');
      const menuDebug = document.getElementById('menuDebug');
      const menuClose = document.getElementById('menuClose');
      const menuVersion = document.getElementById('menuVersion');
      const impressumPage = document.getElementById('impressumPage');
      const debugInfo = document.getElementById('debugInfo');

      // Translation function
      function t(key) {
        return translations[selectedLanguage][key] || key;
      }

      // Update all translatable elements
      function updateLanguage() {
        document.querySelectorAll('[data-i18n]').forEach(element => {
          const key = element.getAttribute('data-i18n');
          element.textContent = t(key);
        });
        // Update popup content for existing circles
        updatePopupContent();
      }

      // Update popup content based on selected language
      function updatePopupContent() {
        videoCircles.forEach(circleData => {
          const { circle, video } = circleData;
          const { title, description, videoUrl } = video;
          const videoTitle = typeof title === 'object' ? (title[selectedLanguage] || title.en) : title;
          const videoDescription = typeof description === 'object' ? (description[selectedLanguage] || description.en) : description;
          
          if (videoTitle || videoDescription) {
            let popupContent = '';
            if (videoTitle) {
              popupContent += `<strong>${videoTitle}</strong>`;
            }
            if (videoDescription) {
              popupContent += videoTitle ? `<br>${videoDescription}` : videoDescription;
            }
            popupContent += `<br><button class="popup-play-button" onclick="playVideoFromPopup('${videoUrl}')">${t('playVideoButton')}</button>`;
            circle.setPopupContent(popupContent);
          }
        });
      }

      const PLAYER_UNSTARTED = -1;
      const PLAYER_ENDED = 0;
      const PLAYER_PLAYING = 1;
      const PLAYER_PAUSED = 2;
      const PLAYER_BUFFERING = 3;

      // Close video and return to map
      closeVideoButton.addEventListener('click', () => {
        stopVideo();
        videoPage.classList.add('hidden');
        mapPage.classList.remove('hidden');
        menuButton.classList.add('show'); // Show menu button
        
        // Fix map display after screen rotation - force Leaflet to recalculate dimensions
        setTimeout(() => {
          if (map) {
            map.invalidateSize();
          }
        }, 100);
      });

      // Menu button - open menu
      menuButton.addEventListener('click', () => {
        menuOverlay.classList.remove('hidden');
      });

      // Menu - Close
      menuClose.addEventListener('click', () => {
        menuOverlay.classList.add('hidden');
      });

      // Menu - Map Home
      menuMapHome.addEventListener('click', () => {
        if (map && configData && configData.defaultPosition) {
          const { latitude, longitude, zoom } = configData.defaultPosition;
          map.setView([latitude, longitude], zoom);
        }
        menuOverlay.classList.add('hidden');
      });

      // Menu - Toggle Fullscreen
      menuFullscreen.addEventListener('click', () => {
        // Check if already in fullscreen (various vendor prefixes)
        const isFullscreen = document.fullscreenElement || 
                           document.webkitFullscreenElement || 
                           document.mozFullScreenElement || 
                           document.msFullscreenElement;
        
        if (!isFullscreen) {
          // Enter fullscreen
          const elem = document.documentElement;
          
          if (elem.requestFullscreen) {
            elem.requestFullscreen().catch(err => {
              console.log('Fullscreen request failed:', err);
              showFullscreenMessage();
            });
          } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen().catch(err => {
              console.log('Webkit fullscreen request failed:', err);
              showFullscreenMessage();
            });
          } else if (elem.webkitEnterFullscreen) {
            elem.webkitEnterFullscreen().catch(err => {
              console.log('Webkit enter fullscreen request failed:', err);
              showFullscreenMessage();
            });
          } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen().catch(err => {
              console.log('MS fullscreen request failed:', err);
            });
          } else {
            showFullscreenMessage();
          }
        } else {
          // Exit fullscreen
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
        menuOverlay.classList.add('hidden');
      });
      
      // Show message for iOS users about fullscreen limitations
      function showFullscreenMessage() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
          alert('iOS Safari does not support fullscreen mode for web pages. For a fullscreen experience, add this page to your home screen and open it from there.');
        }
      }

      // Menu - Restart
      menuRestart.addEventListener('click', () => {
        location.reload();
      });

      // Menu - Change Language
      menuLanguage.addEventListener('click', () => {
        // Cycle through available languages
        const languages = Object.keys(translations);
        const currentIndex = languages.indexOf(selectedLanguage);
        const nextIndex = (currentIndex + 1) % languages.length;
        selectedLanguage = languages[nextIndex];
        
        // Update all UI text
        updateLanguage();
        
        // Update menu version display with current language indicator
        const langNames = { en: 'English', de: 'Deutsch' };
        menuVersion.textContent = (configData?.version ? 'v' + configData.version : 'v1.2.0') + ' - ' + (langNames[selectedLanguage] || selectedLanguage.toUpperCase());
        
        // Keep menu open so user can see the language change
        // menuOverlay.classList.add('hidden'); // Removed - menu stays open
      });

      // Menu - Impressum
      menuImpressum.addEventListener('click', () => {
        menuOverlay.classList.add('hidden');
        impressumPage.classList.remove('hidden');
        loadImpressum();
      });

      // Menu - Toggle Debug
      menuDebug.addEventListener('click', () => {
        debugMode = !debugMode;
        if (debugMode) {
          debugInfo.classList.remove('hidden');
        } else {
          debugInfo.classList.add('hidden');
        }
        menuOverlay.classList.add('hidden');
      });

      // Close Impressum
      document.querySelector('#impressumPage .close-button').addEventListener('click', () => {
        impressumPage.classList.add('hidden');
        menuButton.classList.add('show'); // Show menu button when returning to map
      });

      // Load impressum content from config
      function loadImpressum() {
        const impressumContent = document.getElementById('impressumContent');
        if (configData && configData.impressum) {
          const content = configData.impressum[selectedLanguage] || configData.impressum['en'] || configData.impressum;
          if (typeof content === 'string') {
            impressumContent.innerHTML = '<h1>' + t('impressumTitle') + '</h1><div>' + content + '</div>';
          } else {
            impressumContent.innerHTML = '<h1>' + t('impressumTitle') + '</h1><p>' + t('impressumText') + '</p>';
          }
        } else {
          impressumContent.innerHTML = '<h1>' + t('impressumTitle') + '</h1><p>' + t('impressumText') + '</p>';
        }
      }

      // Update debug info
      function updateDebugInfo(lat, lng, accuracy) {
        if (debugMode) {
          document.getElementById('debugLat').textContent = 'Lat: ' + lat.toFixed(6);
          document.getElementById('debugLng').textContent = 'Lng: ' + lng.toFixed(6);
          document.getElementById('debugAcc').textContent = 'Accuracy: ' + accuracy.toFixed(1) + 'm';
          document.getElementById('debugUpdates').textContent = 'Updates: ' + locationUpdateCount;
        }
      }

      // Step -1: Language Selection
      languageButtons.forEach(button => {
        button.addEventListener('click', () => {
          selectedLanguage = button.getAttribute('data-lang');
          updateLanguage();
          languagePage.classList.add('hidden');
          fullscreenPage.classList.remove('hidden');
        });
      });

      // Step 0: Enter Fullscreen and transition to Info Page
      enterFullscreenButton.addEventListener('click', () => {
        const elem = document.documentElement;
        
        // Try standard fullscreen API
        if (elem.requestFullscreen) {
          elem.requestFullscreen().catch(err => {
            console.log('Fullscreen request failed:', err);
          });
        } 
        // Try webkit fullscreen (iOS Safari)
        else if (elem.webkitRequestFullscreen) {
          elem.webkitRequestFullscreen().catch(err => {
            console.log('Webkit fullscreen request failed:', err);
          });
        }
        // Try webkit enter fullscreen (older iOS)
        else if (elem.webkitEnterFullscreen) {
          elem.webkitEnterFullscreen().catch(err => {
            console.log('Webkit enter fullscreen request failed:', err);
          });
        }
        
        // Transition to info page
        fullscreenPage.classList.add('hidden');
        infoPage.classList.remove('hidden');
      });

      // Step 1: Transition from Info Page to Consent Page
      nextButton.addEventListener('click', () => {
        infoPage.classList.add('hidden');
        consentPage.classList.remove('hidden');
      });

      // Step 2: Consent to Geolocation and Initialize Map
      acceptButton.addEventListener('click', () => {
        consentPage.classList.add('hidden');
        mapPage.classList.remove('hidden');
        menuButton.classList.add('show'); // Show menu button on map page
        // Fetch config first to get default position, then initialize map
        fetch('videos.json')
          .then(response => response.json())
          .then(data => {
            configData = data;
            videosData = data.locations || data;
            
            // Set version from config if available
            if (configData.version) {
              menuVersion.textContent = 'v' + configData.version;
            }
            
            initMap(); // Initialize the map with default position from config
            addVideoLocationsToMap(); // Add locations to map
            getUserLocation(); // Start tracking location after everything is set up
          })
          .catch(error => {
            console.error('Error loading config:', error);
            initMap(); // Fallback to default position if config fails
            getUserLocation();
          });
      });

      // Step 3: Initialize OpenStreetMap
      function initMap() {
        // Use default position from config if available, otherwise fallback to London
        const defaultLat = configData?.defaultPosition?.latitude || 51.505;
        const defaultLng = configData?.defaultPosition?.longitude || -0.09;
        const defaultZoom = configData?.defaultPosition?.zoom || 13;
        
        map = L.map('map').setView([defaultLat, defaultLng], defaultZoom);

        L.maplibreGL({
          style: 'https://tiles.openfreemap.org/styles/positron'
        }).addTo(map);
      }

      /***************************/
      /**                       **/
      /**    GEOLOCATION API    **/
      /**                       **/

      // Step 4: Get the user's location with continuous 5-second updates
      function getUserLocation() {
        if (navigator.geolocation) {
          // Use watchPosition for continuous location updates
          watchId = navigator.geolocation.watchPosition(
            success, 
            error, 
            {
              enableHighAccuracy: true, // enable high accuracy
              timeout: 10000, // wait for 10 seconds
              maximumAge: 0 // don't use cached position
            }
          );
          
          // Set up 5-second interval to request fresh location
          setInterval(() => {
            if (watchId !== null) {
              // watchPosition will automatically trigger success callback
              console.log('Location update requested (5-second interval)');
            }
          }, 5000);
        } else {
          alert('Geolocation is not supported by your browser.');
        }
        
        // callback function on success by geolocation.watchPosition
        function success(position) {
          const { latitude, longitude, accuracy } = position.coords;
          locationUpdateCount++;
          console.log('Location updated:', latitude, longitude, '(Update #' + locationUpdateCount + ')');
          
          // Update debug info
          updateDebugInfo(latitude, longitude, accuracy);
          
          // Skip location updates and proximity checks while video is playing
          if (isVideoPlaying) {
            console.log('Video is playing - skipping location processing');
            return;
          }
          
          if (userMarker) {
            map.removeLayer(userMarker);
          }
          userMarker = L.marker([latitude, longitude]).addTo(map);
          
          // Only center the map on the first location update with higher zoom
          if (!hasInitiallycentered) {
            map.setView([latitude, longitude], 15);
            hasInitiallycentered = true;
          }
          
          checkProximity(latitude, longitude);
        }

        // callback function on error by geolocation.watchPosition
        function error(err) {
          switch(err.code) {
            case err.PERMISSION_DENIED:
              alert("User denied the request for Geolocation.");
              break;
            case err.POSITION_UNAVAILABLE:
              alert("Location information is unavailable.");
              break;
            case err.TIMEOUT:
              alert("The request to get user location timed out.");
              break;
            default:
              alert("An unknown error occurred.");
              break;
          }
          // Stop the geolocation watch listener on error
          if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null; // Clear the watchId after stopping it
          }
        }
      }

      /**                       **/
      /**    GEOLOCATION API    **/
      /**                       **/
      /***************************/


      /***************************/
      /**                       **/
      /**    LOAD CONFIG API    **/
      /**                       **/

      // Step 5: Fetch videos.json file and load locations to map
      function fetchVideoLocations() {
        fetch('videos.json')
          .then((response) => {
            if (!response.ok) {
              throw new Error('Failed to load videos.json');
            }
            return response.json();
          })
          .then((data) => {
            configData = data;
            videosData = data.locations || data; // Support both new structure and old array format
            console.log('Loaded video data:', videosData); // Log the fetched data
            addVideoLocationsToMap(); // Add locations to map only after data is fetched
          })
          .catch((error) => console.error('Error loading video locations:', error));
      }

      // Step 6: Add video location circles to the map
      function addVideoLocationsToMap() {
        videosData.forEach((video, index) => {
          const { latitude, longitude, radius, title, description } = video;

          // Check if latitude, longitude, and radius are defined and valid
          if (typeof latitude === 'number' && typeof longitude === 'number' && typeof radius === 'number') {
            const circle = L.circle([latitude, longitude], {
              color: 'red',
              radius: radius
            }).addTo(map);
            
            // Add popup with title, description, and play button
            const videoTitle = typeof title === 'object' ? (title[selectedLanguage] || title.en) : title;
            const videoDescription = typeof description === 'object' ? (description[selectedLanguage] || description.en) : description;
            
            if (videoTitle || videoDescription) {
              let popupContent = '';
              if (videoTitle) {
                popupContent += `<strong>${videoTitle}</strong>`;
              }
              if (videoDescription) {
                popupContent += videoTitle ? `<br>${videoDescription}` : videoDescription;
              }
              popupContent += `<br><button class="popup-play-button" onclick="playVideoFromPopup('${video.videoUrl}')">${t('playVideoButton')}</button>`;
              circle.bindPopup(popupContent);
              
              // Explicitly add tap event for mobile devices
              circle.on('click', function(e) {
                this.openPopup();
              });
              
              // Store circle and video data for later updates
              videoCircles.push({ circle, video });
            }
          } else {
            console.error(`Invalid data for video location at index ${index}:`, video);
          }
        });
      }

      /**                       **/
      /**    LOAD CONFIG API    **/
      /**                       **/
      /***************************/

      // Step 7: Check proximity to a video location and show popup if in range
      function checkProximity(latitude, longitude) {
        let nearestDistance = Infinity;
        let nearestIndex = -1;
        
        videosData.forEach((video, index) => {
          const distance = map.distance([latitude, longitude], [video.latitude, video.longitude]);
          
          // Track nearest location for debug info
          if (distance < nearestDistance) {
            nearestDistance = distance;
            nearestIndex = index;
          }
          
          if (distance <= video.radius) {
            // User is inside a perimeter - open the popup
            const circleData = videoCircles[index];
            if (circleData && circleData.circle) {
              circleData.circle.openPopup();
            }
          }
        });
        
        // Update debug info with nearest location
        if (debugMode && nearestIndex >= 0) {
          const nearestTitle = videosData[nearestIndex].title[selectedLanguage] || videosData[nearestIndex].title['en'] || 'Location ' + (nearestIndex + 1);
          document.getElementById('debugNearest').textContent = 'Nearest: ' + nearestTitle + ' (' + nearestDistance.toFixed(1) + 'm)';
        }
      }

      // Play video from popup button (global function for onclick)
      window.playVideoFromPopup = function(videoUrl) {
        playVideo(videoUrl);
      };

      // Step 9: Play video (handles delayed video loading)
      function playVideo(videoUrl) {
        const videoId = extractVideoId(videoUrl);
        if (isPlayerReady) {
          player.loadVideoById(videoId);
        } else {
          videoToLoad = videoUrl; // Queue video for later if player is not ready
        }
        // Show video page, hide map page
        mapPage.classList.add('hidden');
        menuButton.classList.remove('show'); // Hide menu button during video
        videoPage.classList.remove('hidden');
      }

      // Stop video playback
      function stopVideo() {
        if (player && typeof player.stopVideo === 'function') {
          player.stopVideo(); // Stop the video playback
        }
      }

      /***********************/
      /**                   **/
      /**    YOUTUBE API    **/
      /**                   **/

      // Step 8: Initialize YouTube IFrame API player
      function onYouTubeIframeAPIReady() {
        // Initialize the YouTube player
        player = new YT.Player('player', {
          height: '315',
          width: '100%',
          playerVars: { 'autoplay': 1, 'controls': 1 },
          events: {
            'onReady': onPlayerReady,
            'onError': onPlayerError,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      var done = false;
      // call back function when youtube player status changed
      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING && !done) {
          isVideoPlaying = true;
          console.log('Video started playing - location updates paused');
          done = true;
        }
        if (event.data == PLAYER_ENDED) {
          isVideoPlaying = false;
          console.log('Video ended - resuming location updates');
          done = false;
        }
      }

      function getPlayerState(){
        if (player && typeof player.stopVideo === 'function') {
          return player.getPlayerState();
        }        
      }

      // call back function when youtube player is ready
      function onPlayerReady(event) {
        isPlayerReady = true;
        if (videoToLoad) {
          const videoId = extractVideoId(videoToLoad);
          console.log('Extracted video ID:', videoId);
          if (videoId && videoId.length === 11) {
            player.loadVideoById(videoId);
          } else {
            console.error('Invalid video ID:', videoToLoad);
          }
          videoToLoad = null; // Clear the queued video after loading
        }
      }

      // call back function when youtube player error occured
      function onPlayerError(event) {
        console.error('Error playing video:', event);
        alert('Failed to load the video. Please try again later.');
      }

      /**                   **/
      /**    YOUTUBE API    **/
      /**                   **/
      /***********************/


      // Utility function to calculate direction based on two sets of lat/lon coordinates
      function calculateDirection(lat1, lon1, lat2, lon2) {
        const rad = Math.PI / 180;
        const dLon = (lon2 - lon1) * rad;
        const y = Math.sin(dLon) * Math.cos(lat2 * rad);
        const x = Math.cos(lat1 * rad) * Math.sin(lat2 * rad) - Math.sin(lat1 * rad) * Math.cos(lat2 * rad) * Math.cos(dLon);
        const bearing = Math.atan2(y, x) * (180 / Math.PI);
        const compassDirections = ['North', 'North-East', 'East', 'South-East', 'South', 'South-West', 'West', 'North-West'];
        const compassIndex = Math.round(((bearing + 360) % 360) / 45) % 8;
        return compassDirections[compassIndex];
      }

      // Utility function to extract video ID from various YouTube URL formats
      function extractVideoId(url) {
          const videoIdMatch = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
          return videoIdMatch ? videoIdMatch[1] : null; // Return the video ID if found
      }

      }); // End DOMContentLoaded

    </script>
  </body>
</html>
